{% load custom_tags %}
{% get_product_groups as groups %}

<style>
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
</style>

<div style="margin-top: 20px; position: relative;">
  <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
    <!-- Single listing -->
    <button id="listing-btn-{{ card_id }}" style="padding: 8px 16px; background-color: #2ecc70ff; color: white; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 6px;">
      ðŸ§¾ List as Single
      <input type="checkbox" id="listing-publish-{{ card_id }}" checked style="margin:0;" />
    </button>

    <!-- Group listing -->
    <div style="position: relative;">
      <button id="add-to-group-btn-{{ card_id }}" style="padding: 8px 16px; background-color: #2ecc70ff; color: white; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 6px;">
        ðŸ§¾ List in Group
        <input type="checkbox" id="group-publish-{{ card_id }}" checked style="margin:0;" />
      </button>
      <div id="group-dropdown-{{ card_id }}" style="display: none; position: absolute; top: 100%; left: 0; background: white; border: 1px solid #ccc; border-radius: 4px; margin-top: 4px; z-index: 10; box-shadow: 0 2px 6px rgba(0,0,0,0.1); min-width: 160px;">
        <!-- Group options will be inserted here -->
      </div>
    </div>

    <!-- Export button unchanged -->
    <button id="export-btn-{{ card_id }}" style="padding: 8px 16px; background-color: #8f2eccff; color: white; border: none; border-radius: 6px; cursor: pointer;">
      ðŸš€ Export
    </button>
  </div>
</div>

<script>
function showSpinnerOnButton(button) {
    button.originalText = button.textContent;
    button.disabled = true;

    const spinner = document.createElement('span');
    spinner.className = 'spinner';
    spinner.style.display = 'inline-block';
    spinner.style.width = '16px';
    spinner.style.height = '16px';
    spinner.style.border = '2px solid #ccc';
    spinner.style.borderTop = '2px solid #333';
    spinner.style.borderRadius = '50%';
    spinner.style.animation = 'spin 0.6s linear infinite';
    spinner.style.marginLeft = '8px';
    button.textContent = '';
    button.appendChild(spinner);
}

function restoreButton(button) {
    button.textContent = button.originalText || 'List in Group';
    button.disabled = false;
}
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const cardId = "{{ card_id }}";
  const searchResultId = "{{ search_result.id }}";

  const listingBtn = document.getElementById(`listing-btn-${cardId}`);
  const groupBtn = document.getElementById(`add-to-group-btn-${cardId}`);
  const dropdown = document.getElementById(`group-dropdown-${cardId}`);
  const exportBtn = document.getElementById(`export-btn-${cardId}`);

  const listingPublish = document.getElementById(`listing-publish-${cardId}`);
  const groupPublish = document.getElementById(`group-publish-${cardId}`);

  const groupData = {{ groups|safe }};
  let dropdownInitialized = false;

  // Single listing
  listingBtn.addEventListener('click', (e) => {
    if (e.target.tagName.toLowerCase() === 'input') return;
    const publishValue = listingPublish.checked ? "True" : "False";
    console.log(`Listing triggered for ${listingBtn.id}, publish=${publishValue}`);
    fetch(`/list_card/${searchResultId}?publish=${publishValue}`)
      .then(res => res.json())
      .then(data => console.log("Response:", data));
  });

  // Group listing dropdown
  groupBtn.addEventListener('click', (e) => {
    if (e.target.tagName.toLowerCase() === 'input') return;

    if (!dropdownInitialized) {
      // Existing groups
      groupData.forEach(group => {
        const item = document.createElement('div');
        item.textContent = group.name;
        item.group_id = group.id;
        item.style.padding = '8px 12px';
        item.style.cursor = 'pointer';
        item.style.borderBottom = '1px solid #eee';
        item.addEventListener('mouseover', () => item.style.backgroundColor = '#f0f0f0');
        item.addEventListener('mouseout', () => item.style.backgroundColor = 'white');
        item.addEventListener('click', () => {
          const publishValue = groupPublish.checked ? "True" : "False";
          console.log(`Group listing triggered for ${groupBtn.id}, publish=${publishValue}`);
          dropdown.style.display = 'none';
          showSpinnerOnButton(groupBtn);

          fetch(`/list_card/${searchResultId}?publish=${publishValue}&group_key=${item.group_id}`)
            .then(res => res.json())
            .then(data => console.log("Response:", data))
            .catch(err => console.error("Listing failed:", err))
            .finally(() => {
              restoreButton(groupBtn);
              location.reload();
            });
        });
        dropdown.appendChild(item);
      });

      // Add New Group option
      const addNewGroup = document.createElement('div');
      addNewGroup.textContent = "âž• Add New Group...";
      addNewGroup.style.padding = '8px 12px';
      addNewGroup.style.cursor = 'pointer';
      addNewGroup.style.borderBottom = '1px solid #eee';
      addNewGroup.addEventListener('mouseover', () => addNewGroup.style.backgroundColor = '#f0f0f0');
      addNewGroup.addEventListener('mouseout', () => addNewGroup.style.backgroundColor = 'white');
      addNewGroup.addEventListener('click', () => {
        dropdown.style.display = 'none';
        const newGroupName = prompt("Enter a name for the new group:");
        if (newGroupName && newGroupName.trim() !== "") {
          const publishValue = groupPublish.checked ? "True" : "False";
          fetch(`/list_card/${searchResultId}?publish=${publishValue}&group_key=${encodeURIComponent(newGroupName)}`)
            .then(res => res.json())
            .then(data => console.log("New group created:", data))
            .catch(err => console.error("Failed to create new group:", err));
        }
      });
      dropdown.appendChild(addNewGroup);

      dropdownInitialized = true;
    }

    dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
  });

  // Export unchanged
  exportBtn.addEventListener('click', () => {
    console.log(`Export triggered for ${listingBtn.id}`);
    fetch(`/export/${searchResultId}/`).then(res => res.json());
  });
});
</script>