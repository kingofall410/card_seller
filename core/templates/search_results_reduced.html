{% load static %}
{% load custom_tags %}
{% get_overrideables as overrideables %}
{% get_display as displayable %}
{% get_calculated as calculated %}
{% get_textonly as textonly %}
{% get_checkboxes as checkboxes %}

<script src="{% static 'js/search_results.js' %}"></script>

<style>
  input:disabled {
    background-color: #f9f9f9;
    color: #999;
    cursor: not-allowed;
  }

  .ui-menu-item.autocomplete-disabled.ui-state-active {
  background-color: #ffe5e5 !important; /* light red background */
  color: #d00 !important;               /* strong red text */
  font-weight: bold;
}

  .autocomplete-disabled {
    color: #999;
    pointer-events: none;
    cursor: default;
  }

.input-error { 
  border: 2px solid red;
  background-color: #ffe5e5;
}

</style>

{{ card_id }} -- {{ search_result.id }} 
<table id="fields-{{ card_id }}" style="font-size: 14px; border-collapse: collapse; width: 100%; border: 1px solid #ccc;">

<tbody>
  {% with card_counter=card_id title=search_result|get_attribute:"title_to_be" price=search_result|get_attribute:"list_price" ebay_listing_id=search_result|get_attribute:"ebay_listing_id" %}
    <!-- 🏷️ Title Row -->
    <tr>
      <td colspan="4" style="padding: 8px 6px; font-weight: bold; background-color: #4c96d7;"> 
      <input type="text"
                id="field_title_to_be-{{ card_counter }}"
                name="title_to_be_m"
                value="{{ title }}"
                style="width: 100%; box-sizing: border-box; font-size: 1.25em; padding: 5px; 8px; border: 2px solid #ccc; border-radius: 6px;"
                data-default="{{ title }}"
                data-maxlength="80"
                oninput="rebuildTitle('title_to_be', {{ card_counter }})">
      </td>
    </tr>
    
{% for field_name in search_result.display_fields %}
      {% with display_attr="display_"|add:field_name manual_flag=field_name|add:"_is_manual" resolved_value=search_result|get_attribute:field_name %}
      <tr style="border-bottom: 3px solid #eee;">
        <!-- 🟩 Label + Override Checkbox -->
        <td colspan="2" style="padding: 6px;">
          <label style="display: flex; align-items: center; gap: 6px;">
            {% if field_name in checkboxes %}
            <input type="checkbox"
                id="{{ field_name }}_is_manual-{{ card_counter }}"
                name="{{ field_name }}_is_manual"
                checked disabled
                onchange="handleOverrideToggle('{{ field_name }}', {{ card_counter }})">
            {% else %}
            <input type="checkbox"
                id="{{ field_name }}_is_manual-{{ card_counter }}"
                name="{{ field_name }}_is_manual"
                {% if search_result|get_attribute:manual_flag %}checked{% endif %}
                onchange="handleOverrideToggle('{{ field_name }}', {{ card_counter }})">
            {% endif %}
            <span>{{ search_result|get_field_verbose:field_name }}</span>
          </label>
        </td>
      
        {% with display_attr="display_"|add:field_name manual_flag=field_name|add:"_is_manual"%}
        {% with resolved_value=search_result|get_attribute:display_attr %}
        <!-- 🟦 Field Input -->
        <td colspan="2" style="padding: 6px; width: 300px;">
          {% if field_name in overrideables %}
            <!-- A: Editable input -->
            <input type="text"
                id="field_{{ field_name }}-{{ card_counter }}"
                name="{{ field_name }}_m"
                value="{{ resolved_value }}"
                style="width: 100%; box-sizing: border-box;"
                data-default="{{ resolved_value }}"
                oninput="rebuildTitle('{{ field_name }}', {{ card_counter }})"
                onkeydown="if (event.key === 'Enter') handleEnterPress('{{ field_name }}', {{ card_counter }}, {{ search_result.id }})"
                onblur="handleEnterPress('{{ field_name }}', {{ card_counter }}, {{ search_result.id }})"
                {% if not search_result|get_attribute:manual_flag %}disabled{% endif %}>
          
          {% elif field_name in calculated %}
            <!-- B: Calculated input -->
            <input type="text"
                id="field_{{ field_name }}-{{ card_counter }}"
                name="{{ field_name }}_m"
                value="{{ resolved_value }}"
                style="width: 100%; box-sizing: border-box;"
                data-default="{{ resolved_value }}"
                oninput="rebuildTitle('{{ field_name }}', {{ card_counter }})"
                {% if not search_result|get_attribute:manual_flag %}disabled{% endif %}>
            {% elif field_name in checkboxes %}
              <!-- D: Checkbox group -->
              <div style="display: flex; flex-wrap:wrap; gap: 8px;">
              {% get_all_options field_name as options %}
              {% for option in options %}
                <label style="margin-bottom: 4px;">
                  <input type="checkbox"
                        id="field_{{ field_name }}-{{ option }}-{{ card_counter }}"
                        name="{{ field_name }}.{{ option }}"
                        value="true"
                        {% if search_result.attribute_flags|dict_get:option == True %}checked{% endif %}
                        onchange="handleEnterPress('{{ field_name }}-{{ option }}', {{ card_counter }}, {{ search_result.id }})">
                  {{ option }}
                </label>
              {% endfor %}
          </div>
          {% elif field_name in textonly %}
            <!-- E: Textarea for text-only fields -->
            <textarea
                id="field_{{ field_name }}-{{ card_counter }}"
                name="{{ field_name }}_m"
                rows="5"
                style="width: 100%; box-sizing: border-box;"
                data-default="{{ resolved_value }}"
                oninput="rebuildTitle('{{ field_name }}', {{ card_counter }})">
              {{ resolved_value }}
            </textarea>


          {% else %}
            <!-- C: Fallback textarea -->
            <input type="text"
                id="field_{{ field_name }}-{{ card_counter }}"
                name="{{ field_name }}"
                value="{{ resolved_value }}"
                style="width: 100%; box-sizing: border-box;"
                data-default="{{ resolved_value }}"
                oninput="rebuildTitle('{{ field_name }}', {{ card_counter }})"
                onkeydown="if (event.key === 'Enter') handleEnterPress('{{ field_name }}', {{ card_counter }}, {{ search_result.id }})"
                onblur="handleEnterPress('{{ field_name }}', {{ card_counter }}, {{ search_result.id }})">
          {% endif %}
        </td>
{% endwith %}
      </tr>
      {% endwith %}
      {% endwith %}
      {% endfor %}

  {% endwith %}
</tbody>

      </table>