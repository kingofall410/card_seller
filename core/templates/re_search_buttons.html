<div style="margin-top: 20px; display: flex; gap: 10px;">
    <button id="image-search-btn-{{ card_id }}" style="padding: 8px 16px; background-color: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer;">
        ğŸ–¼ï¸ Image Search
    </button>
    <button id="text-search-btn-{{ card_id }}" style="padding: 8px 16px; background-color: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer;">
        ğŸ”¤ Text Search
    </button>
    <button id="export-btn-{{ card_id }}" style="padding: 8px 16px; background-color: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer;">
        ğŸ‘‡ Download
    </button>
    <button id="retokenize-btn-{{ card_id }}" style="padding: 8px 16px; background-color: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer;">
        ğŸ” Retokenize
    </button>
    <button id="crop-btn-{{ card_id }}" style="padding: 8px 16px; background-color: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer;">
        âœ‚ Crop
    </button>
    <button id="save-btn-{{ card_id }}" style="padding: 8px 16px; background-color: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer;">
        ğŸ’¾ Save
    </button>
    <button id="save-next-btn-{{ card_id }}" style="padding: 8px 16px; background-color: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer;">
        ğŸ’¾â†’ Save & Next
    </button>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const imageSearchBtn = document.getElementById("image-search-btn-{{ card_id }}");
        const retokenizeBtn = document.getElementById("retokenize-btn-{{ card_id }}");
        const textSearchBtn = document.getElementById("text-search-btn-{{ card_id }}");
        const exportBtn = document.getElementById("export-btn-{{ card_id }}");
        const cropBtn = document.getElementById("crop-btn-{{ card_id }}");
        const saveBtn = document.getElementById("save-btn-{{ card_id }}");
        const saveNextBtn = document.getElementById("save-next-btn-{{ card_id }}");
        const searchResultId = "{{ search_result.id }}"
        const cardId = "{{ card_id }}";

        imageSearchBtn.addEventListener('click', () => {
            console.log(`ğŸ–¼ï¸ Image Search triggered for ${imageSearchBtn.id}`);
            fetch(`/image_search/${cardId}/`, { 
                method: 'POST',
            }).then(response => {
                console.log("Successfully");
                location.reload()
            }).catch(error => {
                console.error("Save error", error);
            });
        });
        retokenizeBtn.addEventListener('click', () => {
            fetch(`/retokenize/${searchResultId}/`, { 
                method: 'POST',
            }).then(response => {
                console.log("Successfully");
                location.reload()
            }).catch(error => {
                console.error("Save error", error);
            });
        });
        exportBtn.addEventListener('click', () => {
            //TODO:reimplement this when needed as download csv
            console.log(` Export triggered for ${exportBtn.id}`);
            console.log(searchResultId);
            //fetch(`/export/${searchResultId}/`)
              //  .then(res => res.json())
                
        });
        saveBtn.addEventListener('click', () => {
            
            console.log(` Save triggered for ${saveBtn.id}`);
            console.log(searchResultId);
            allFields = collectAllFields(cardId);
            //TODO:fix this hack maybe
            allFields["notes"] = document.getElementById("notes").value
            console.log("Fields:", allFields);

            $.ajax({
                url: "/update_csr_fields/",
                method: "POST",
                data: {
                    csrId: searchResultId,
                    ...allFields,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: response => {
                    console.log("Saved:", response);
                    alert("Changes saved successfully.");
                },
                error: xhr => {
                    console.error("Save error:", xhr.responseText);
                    alert("Error saving changes.");
                }
            });       
        });
        saveNextBtn.addEventListener('click', () => {
            
            console.log(` Save triggered for ${saveBtn.id}`);
            console.log(searchResultId);
            allFields = collectAllFields(cardId);
            //TODO:fix this hack maybe
            allFields["notes"] = document.getElementById("notes").value
            console.log("Fields:", allFields);

            $.ajax({
                url: "/update_csr_fields/",
                method: "POST",
                data: {
                    csrId: searchResultId,
                    ...allFields,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: response => {
                    handleNext()
                },
                error: xhr => {
                    console.error("Save error:", xhr.responseText);
                    alert("Error saving changes.");
                }
            });       
        });
        cropBtn.addEventListener('click', () => {
            console.log(` Detailed Crop page `);
            window.location.href = "/full_crop/" + cardId;
                
        });
        
        textSearchBtn.addEventListener('click', () => {
            console.log("ğŸ”¤ Text Search triggered for fields-1");
            
            // Show loading indicator
            textSearchBtn.innerHTML = "ğŸ”„ Searching...";
            textSearchBtn.disabled = true;

            fetch(`/text_search/${cardId}/`, { 
                method: 'POST',
            }).then(response => {
                console.log("Successfully");
                location.reload()
            }).catch(error => {
                console.error("Save error", error);
                
                // Restore button state on error
                textSearchBtn.innerHTML = "ğŸ” Text Search";
                textSearchBtn.disabled = false;
            });
        });
    });
</script>