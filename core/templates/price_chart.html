<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>eBay Price Distribution</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    #chart-container {
      width: 1200px;
      height: 400px;
      margin: 40px auto;
    }
  </style>
</head>

<body>
  <div id="chart-container">

    <canvas id="priceChart"></canvas>
  </div>
  <div id="selected-price" data-shared="{{ some_value }}"></div>

</body>
</html>

<script>
  // Sample price data from eBay
  const priceData = JSON.parse(`{{ prices | safe }}`);

  // Extract raw prices
  const prices = priceData.map(p => p[0]);

  // Compute mean and standard deviation
  function getMean(arr) {
    const sum = arr.reduce((acc, val) => acc + val, 0);
    return sum / arr.length;
  }

  function getStdDev(arr, mean) {
    const variance = arr.reduce((acc, val) => acc + Math.pow(val - mean, 2), 0) / arr.length;
    return Math.sqrt(variance);
  }

  const mean = getMean(prices);
  const stdDev = getStdDev(prices, mean);
  const cutoff = `{{ settings.nr_std_devs }}`; // ⬅️ Change this to adjust filtering threshold

  // Filter out prices beyond ±cutoff * stdDev
  const filteredPriceData = priceData.filter(([price]) => {
    return Math.abs(price - mean) <= cutoff * stdDev;
  });

  const filteredPrices = filteredPriceData.map(p => p[0]);

  // Bin setup: $1-wide bins labeled as "42.99"
  const binSize = 1;
  const minPrice = Math.floor(Math.min(...filteredPrices));
  const maxPrice = Math.ceil(Math.max(...filteredPrices));

  const bins = {};
  for (let i = minPrice; i <= maxPrice; i++) {
    const binLabel = `${(i + 0.99).toFixed(2)}`;
    bins[binLabel] = 0;
  }

  // Assign prices to bins
  filteredPriceData.forEach(([price, title]) => {
    const binFloor = Math.floor(price);
    const binLabel = `${(binFloor + 0.99).toFixed(2)}`;
    if (bins[binLabel] !== undefined) {
      bins[binLabel] += 1;
    }
  });

  const histogramLabels = Object.keys(bins);
  const histogramData = Object.values(bins);

  // Scatter plot: each price aligned to its bin label
  const scatterData = filteredPriceData.map(([price, title, thumb]) => ({
    x: `${Math.floor(price) + 0.99}`,
    y: price,
    title: title,
    thumb: thumb
  }));

  // Chart.js setup
  const ctx = document.getElementById('priceChart').getContext('2d');
  

    const externalTooltipHandler = (context) => {
    const { chart, tooltip } = context;

    // Remove any existing tooltip
    let tooltipEl = document.getElementById('chartjs-tooltip');
    if (tooltipEl) tooltipEl.remove();

    if (!tooltip || tooltip.opacity === 0 || !tooltip.dataPoints?.length) return;

    const point = tooltip.dataPoints[0].raw;

    const canvasRect = chart.canvas.getBoundingClientRect();

    // Create tooltip container
    tooltipEl = document.createElement('div');
    tooltipEl.id = 'chartjs-tooltip';
    tooltipEl.style.position = 'absolute';
    tooltipEl.style.left = canvasRect.left + window.pageXOffset + tooltip.caretX + 'px';
    tooltipEl.style.top = canvasRect.top + window.pageYOffset + tooltip.caretY + 'px';
    tooltipEl.style.background = '#fff';
    tooltipEl.style.border = '1px solid #ccc';
    tooltipEl.style.borderRadius = '6px';
    tooltipEl.style.padding = '8px';
    tooltipEl.style.pointerEvents = 'none';
    tooltipEl.style.boxShadow = '0 2px 6px rgba(0,0,0,0.15)';
    tooltipEl.style.fontSize = '12px';
    tooltipEl.style.zIndex = 1000;
    tooltipEl.style.maxWidth = '300px';

    console.log(point)

    if (point.y) {
      //scatterplot
      
      // Build table layout
      tooltipEl.innerHTML = `
        <div style="font-weight:bold; margin-bottom:6px;">$${point.y.toFixed(2)}</div>
        <table style="width:100%; border-collapse:collapse;">
          <tr>
            <td style="width:60px; vertical-align:top;">
              <img src="${point.thumb}" style="width:60px; height:auto; border-radius:4px;" />
            </td>
            <td style="padding-left:8px; vertical-align:top;">
              <div><strong>Price:</strong> $${point.y.toFixed(2)}</div>
              <div><strong>Item:</strong> ${point.title}</div>
            </td>
          </tr>
        </table>
      `;
    } else {
      //histogram bar
      // histogram bar
        const binTop = parseFloat(tooltip.dataPoints[0].label); // this is your x-axis label
        const binBottom = binTop - 0.99;

        tooltipEl.innerHTML = `
          <div style="font-weight:bold;">Bin: $${binBottom.toFixed(2)} - $${binTop.toFixed(2)}</div>
          <div>Bucket listings: ${point}</div>
        `;

    }
    document.body.appendChild(tooltipEl);
    

  };


  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: histogramLabels,
      datasets: [
        {
          label: 'Item Count per Price Bin',
          data: histogramData,
          backgroundColor: 'rgba(54, 162, 235, 0.6)',
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 1,
          yAxisID: 'y'
        },
        {
          label: 'Actual Prices',
          data: scatterData,
          type: 'scatter',
          backgroundColor: 'rgba(255, 206, 86, 0.8)',
          pointRadius: 4,
          yAxisID: 'y1'
        }
      ]
    },
    options: {
      maintainAspectRatio:false,
      scales: {
        x: {
          type: 'category',
          position: 'bottom',
          title: {
            display: true,
            text: 'Price Bins ($)'
          },
          ticks: {
            autoSkip: false,
            maxRotation: 45,
            minRotation: 45
          }
        },
        y: {
          type: 'linear',
          position: 'left',
          title: {
            display: true,
            text: 'Item Count'
          },
          beginAtZero: true,
          min: 0
        },
        y1: {
          type: 'linear',
          position: 'right',
          title: {
            display: true,
            text: 'Actual Price ($)'
          },
          grid: {
            drawOnChartArea: false
          },
          min: Math.max(0, Math.min(...filteredPrices) - 5),
          max: Math.max(...filteredPrices) + 2
        }
      },
      plugins: {
        tooltip: {
          enabled: false, // ⛔ disables built-in tooltip
          external: externalTooltipHandler // ⬅️ use custom handler
        }
      },
      onClick: (event, elements, chart) => {
        const activePoints = chart.getElementsAtEventForMode(event, 'nearest', { intersect: true }, false);
        const priceElem = document.getElementById("selected-price")
        console.log("priceelem:", priceElem)
        if (activePoints.length > 0) {
          const point = activePoints[0];
          const datasetIndex = point.datasetIndex;
          const index = point.index;
          const dataset = chart.data.datasets[datasetIndex];
          const dataPoint = dataset.data[index];

          let sharedValue;
          // 🔥 Your callback logic here
          console.log("Clicked point:", dataPoint);
          if (dataPoint.y) {
            sharedValue = dataPoint.y            
          } else {
            console.log(activePoints)
            sharedValue = chart.data.labels[index];      
          }
            priceElem.setAttribute("data-shared", sharedValue);
        }
      },
    }
  });
</script>

