{% load custom_tags %}
{% get_overrideables as overrideables %}
{% get_display as displayable %}
{% get_calculated as calculated %}
{% get_textonly as textonly %}


<style>
  input:disabled {
    background-color: #f9f9f9;
    color: #999;
    cursor: not-allowed;
  }
</style>

<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<script>
$(document).ready(function () {
    
  document.querySelectorAll(`input[type='text'][id^='title_to_be']`).forEach(input => {
    handleManualInput(input); // Run once on init
  });
  
  // ðŸ§© Allow HTML in autocomplete labels
  $.ui.autocomplete.prototype._renderItem = function (ul, item) {
    return $("<li>").append(`<div>${item.label}</div>`).appendTo(ul);
  };

  // ðŸ—‚ï¸ Initialize saved values
  const savedValues = {};
  $("input[type='text']").each(function () {
    let name = $(this).attr("name");
    const value = $(this).val();

    if (name && name.endsWith("_m")) {
      name = name.slice(0, -2);
    }

    if (name) {
      if (!savedValues[name]) {
        savedValues[name] = new Set();
      }
      savedValues[name].add(value);
    }
  });
  //console.log("AC: Autocomplete options:", autocompleteOptions);

  {% for field_name in search_result.display_fields %}
  (function () {
    const fieldName = "{{ field_name|escapejs }}";
    const selector = `#field_${fieldName}-{{ card_id }}`;
    const cardId = "{{ card_id }}";
    const csrId = "{{ search_result.id }}";
    let fields = collectAllFields(cardId);
    console.log("Collected fields no?:", fields);
    $(selector).autocomplete({
      minLength: 1,
      autoFocus: true,
      source: function (request, response) {
        
        fields = collectAllFields(cardId);
        console.log("Collected fields ya?:", fields);
        $.ajax({
          url: "/autocomplete/",
          type: "POST", // must be POST to send JSON body
          data: JSON.stringify({
            term: request.term,
            field: fieldName,
            allFields: { ...fields },
            csrId: csrId
          }),
          contentType: "application/json", // correct header for JSON
          success: function (data) {
            const results = data.map(opt => ({
              label: opt.label,
              value: opt.value
            }));

            if (results.length === 0) {
              results.push({
                label: `<em>Add '${request.term}'</em>`,
                value: "__add__",
                rawValue: request.term
              });
            }

            response(results);
          },
          error: function (xhr) {
            console.error("Autocomplete error:", xhr.responseText);
            response([]);
          }
        });

      },
      select: function (event, ui) {
        const match = this.id.match(/^field_(.+)-(\d+)$/);
        if (!match) {
          console.warn("Unexpected field ID format:", this.id);
          return;
        }

        const fieldName = match[1];
        const cardId = match[2];

        console.log(cardId)
        if (ui.item.value === "__add__") {
          const inputValue = ui.item.rawValue;
          const allFields = collectAllFields(cardId);

          allFields["new_field"] = fieldName;
          allFields["new_value"] = inputValue;

          if (!savedValues[fieldName]) {
            savedValues[fieldName] = new Set();
          }
          savedValues[fieldName].add(inputValue);
        
          $.ajax({
            url: "/add_token/",
            method: "POST",
            headers: {
              'Content-Type': 'application/json',
            },
            
            data: JSON.stringify({
              field_key: fieldName,
              token: inputValue,
              fields: allFields ,
            }),
            success: response => console.log("Token added:", response),
            error: xhr => console.error("Error adding token:", xhr.responseText)
          });

          handleManualInput(fieldName, cardId);
          return false;
        } else {
          $(this).val(ui.item.value);
          handleManualInput(fieldName, cardId);
          return false;
        }
      }
    })
    .on("focus", function () {
      $(this).select();
      $(this).autocomplete("search", $(this).val());
    })
    .on("blur", function () {
      const input = $(this);
      const rawValue = input.val();

      const match = this.id.match(/^field_(.+)-(\d+)$/);
      if (!match) {
        console.warn("Unexpected field ID format on blur:", this.id);
        return;
      }

      const fieldName = match[1];
      const cardId = match[2];

      const knownValues = savedValues[fieldName] || new Set();
      if (!knownValues.has(rawValue)) {
        console.log("Manual blur entry detected:", rawValue);

        if (!savedValues[fieldName]) {
          savedValues[fieldName] = new Set();
        }
        savedValues[fieldName].add(rawValue);

        const allFields = collectAllFields(cardId);
        allFields["new_field"] = fieldName;
        allFields["new_value"] = rawValue;

        handleManualInput(allFields, cardId);
      }
    });
  })();
{% endfor %}



  // ðŸ’¾ Save button handler
  $("#saveFieldsBtn").on("click", function () {
    let cardId = "{{ card_id }}"
    console.log("cid", cardId)
    const allFields = collectAllFields(cardId);

    console.log("Payload:", {
      csrId: "{{ search_result.id }}",
      ...allFields,
      csrfmiddlewaretoken: '{{ csrf_token }}'
    });

    $.ajax({
      url: "/update_csr_fields/",
      method: "POST",
      data: {
        csrId: "{{ search_result.id }}",
        ...allFields,
        csrfmiddlewaretoken: '{{ csrf_token }}'
      },
      success: response => {
        console.log("Saved:", response);
        alert("Changes saved successfully.");
      },
      error: xhr => {
        console.error("Save error:", xhr.responseText);
        alert("Error saving changes.");
      }
    });
  });
});

function collectAllFields(cardId) {
  const allFields = {};
  console.log(cardId)
  // Text inputs
  document.querySelectorAll(`input[type='text'][id$='-${cardId}'], textarea[id$='-${cardId}']`).forEach(el => {

    let name = el.name;
    console.log(el.name)
    const value = el.value;

    if (name && name.endsWith("_m")) {
      name = name.slice(0, -2);
    }
    if (name && name.endsWith(`-${cardId}`)) {
      name = name.slice(0, -(`-${cardId}`.length));
    }

    if (name) {
      allFields[name] = value;
    }
  });

  // Checkboxes
  document.querySelectorAll(`input[type='checkbox'][id$='-${cardId}']`).forEach(checkbox => {
    let name = checkbox.name;
    const value = checkbox.checked

    if (name && name.endsWith(`_${cardId}`)) {
      name = name.slice(0, -(`_${cardId}`.length));
    }

    if (name) {
      allFields[name] = value;
    }
  });

  return allFields;
}



// Enable/disable field on checkbox toggle
function handleOverrideToggle(fieldName, cardId) {
  const checkbox = document.getElementById(`${fieldName}_is_manual-${cardId}`);
  const input = document.getElementById(`field_${fieldName}-${cardId}`);

  if (checkbox.checked) {
    input.removeAttribute("disabled");
  } else {
    input.setAttribute("disabled", "disabled");
    const defaultValue = input.getAttribute("data-default");
    input.value = defaultValue || "-";
  }
}


function handleManualInput(fieldName, cardId) {
  console.log(`handleManualInput called with field="${fieldName}", idx=${cardId}`);

  const titleFieldId = `field_title_to_be-${cardId}`;
  const thisFieldId = `${fieldName}-${cardId}`;
  console.log("titleFieldId:", titleFieldId);
  console.log("thisFieldId:", thisFieldId);

  if (titleFieldId !== `field_${thisFieldId}`) {
    const titleCheckbox = document.getElementById(`title_to_be_is_manual-${cardId}`);
    const titleElement = document.getElementById(titleFieldId);

    if (titleElement) {// && !titleCheckbox.checked) {
      // â³ Delay field collection until DOM updates
      setTimeout(() => {
        const fields = collectAllFields(cardId);
        console.log("Collected fields2:", fields);

        // #this is a re-implementation of csr.build_title
        const titleParts = [
          fields.year,
          fields.brand,
          fields.subset,
          fields.full_name,
          fields.parallel,
          fields.serial_number !="-" ? `${fields.serial_number}` : null,
          fields.card_number != "-" ? `#${fields.card_number}` : null,
          fields.city,
          fields.team
        ];

      titleElement.value = titleParts
        .filter(part => part && part.trim() !== '') // Remove null/empty/whitespace-only
        .join(' ');

        //titleElement.value = `${fields.year} ${fields.brand} ${fields.subset} ${fields.full_name} ${fields.serial_number} #${fields.card_number} ${fields.city} ${fields.team}`;

      }, 0);
    } else {
      console.log("No title element or checkbox is checked.");
    }
  }
} 
</script>

{{ search_result.id }}
<table id="fields-{{ card_id }}" style="font-size: 14px; border-collapse: collapse; width: 100%; border: 1px solid #ccc;">
<thead>
    <tr style="background-color: #f0f0f0;">
        <th style="padding: 8px;">Field</th>
        <th style="padding: 8px;">Value</th>
    </tr>
</thead>
<tbody>
  {% with card_counter=card_id resolved_value=search_result|get_attribute:"title_to_be" %}
    <!-- ðŸ·ï¸ Title Row -->
    <tr>
      <td colspan="2" style="padding: 8px 6px; font-weight: bold; background-color: #f8f9fa;">
        <input type="text"
                id="field_title_to_be-{{ card_counter }}"
                name="title_to_be_m"
                value="{{ resolved_value }}"
                style="width: 100%; box-sizing: border-box;"
                data-default="{{ resolved_value }}">
      </td>
    </tr>

    {% for field_name in search_result.display_fields %}
      {% with display_attr="display_"|add:field_name manual_flag=field_name|add:"_is_manual" resolved_value=search_result|get_attribute:field_name %}
      <tr style="border-bottom: 1px solid #eee;">
        <!-- ðŸŸ© Label + Override Checkbox -->
        <td style="padding: 6px;">
          <label style="display: flex; align-items: center; gap: 6px;">
            {% if field_name in overrideables or field_name in calculated %}
              <input type="checkbox"
                  id="{{ field_name }}_is_manual-{{ card_counter }}"
                  name="{{ field_name }}_is_manual"
                  {% if search_result|get_attribute:manual_flag %}checked{% endif %}
                  onchange="handleOverrideToggle('{{ field_name }}', {{ card_counter }})">
            {% elif field_name in textonly %}
              <input type="checkbox"
                  id="{{ field_name }}_is_manual-{{ card_counter }}"
                  name="{{ field_name }}_is_manual"
                  checked disabled
                  onchange="handleOverrideToggle('{{ field_name }}', {{ card_counter }})">
            {% endif %}
            <span>{{ search_result|get_field_verbose:field_name }}</span>
          </label>
        </td>

        <!-- ðŸŸ¦ Field Input -->
        <td style="padding: 6px; width: 300px;">
          {% if field_name in overrideables %}
            <!-- A: Editable input -->
            <input type="text"
                id="field_{{ field_name }}-{{ card_counter }}"
                name="{{ field_name }}_m"
                value="{{ resolved_value }}"
                style="width: 100%; box-sizing: border-box;"
                data-default="{{ resolved_value }}"
                oninput="handleManualInput('{{ field_name }}', {{ card_counter }})"
                {% if not search_result|get_attribute:manual_flag %}disabled{% endif %}>
          
          {% elif field_name in calculated %}
            <!-- B: Calculated input -->
            <input type="text"
                id="field_{{ field_name }}-{{ card_counter }}"
                name="{{ field_name }}_m"
                value="{{ resolved_value }}"
                style="width: 100%; box-sizing: border-box;"
                data-default="{{ resolved_value }}"
                oninput="handleManualInput('{{ field_name }}', {{ card_counter }})"
                {% if not search_result|get_attribute:manual_flag %}disabled{% endif %}>
        
          {% else %}
            <!-- C: Fallback textarea -->
            <textarea
                id="field_{{ field_name }}-{{ card_counter }}"
                name="{{ field_name }}_m"
                rows="5"
                style="width: 100%; box-sizing: border-box;"
                data-default="{{ resolved_value }}"
                oninput="handleManualInput('{{ field_name }}', {{ card_counter }})"
            >{{ resolved_value }}</textarea>
          {% endif %}
        </td>
      </tr>
      {% endwith %}
    {% endfor %}
  {% endwith %}
</tbody>


</table>
<div style="margin-top: 16px; text-align: right;">
  <button id="saveFieldsBtn" style="padding: 8px 16px; font-size: 14px;">
    Save
  </button>
</div>







