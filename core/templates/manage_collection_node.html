<style>
  
.card-list {
  display: flex;
  flex-wrap: wrap; /* allows wrapping to next line if needed */
  gap: 12px;        /* spacing between cards */
  padding: 8px 0;
}

.card-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 150px;
  padding: 6px;
  border: 1px solid #ccc;
  border-radius: 6px;
  background-color: #f9f9f9;
  text-align: center;
  position: relative;
}

.card-count {
  position: absolute;
  top: 8px;
  left: 8px;
  z-index: 10;
  margin-bottom: 4px;
}

.status-icon {
  position: absolute;
  bottom: 2px;
  left: 2px;
  font-size: 0.85em;
}
.image-wrapper {
  position: relative;
  width: 150px;
  height: 210px; /* or match your image height */
  overflow: hidden;
  margin-bottom: 6px;
}

.thumbnail {
  position: absolute;
  top: 4px;
  left: 4px;
  width: calc(100% - 8px); /* ‚¨ÖÔ∏è account for padding */
  height: auto;
  border-radius: 4px;
  transition: opacity 0.3s ease;
}


.thumbnail.hover {
  opacity: 0;
  z-index: 2;
}

.image-wrapper:hover .thumbnail.hover {
  opacity: 1;
}

.image-wrapper:hover .thumbnail.default {
  opacity: 0;
}

.tooltip-wrapper {
  position: relative;
  display: inline-block;
}

.tooltip-wrapper::after {
  content: attr(data-tooltip);
  position: absolute;
  bottom: 125%; /* above the button */
  left: 50%;
  transform: translateX(-50%);
  background-color: #333;
  color: #fff;
  padding: 4px 8px;
  border-radius: 4px;
  white-space: nowrap;
  font-size: 0.75em;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s ease;
  z-index: 10;
}

.tooltip-wrapper:hover::after {
  opacity: 1;
}
.add-controls {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 6px;
  width: 144px;
  height: 274px;
  padding: 8px;
  border: 2px dashed #aaa;
  border-radius: 6px;
  background-color: #f0f0f0;
}

.card-sort-controls {
    margin-top: 6px;
}

.add-button {
  width: 100%;
  padding: 6px 0;
  font-size: 0.9em;
  background-color: #e0e0e0;
  border: 1px solid #ccc;
  border-radius: 4px;
  cursor: pointer;
  text-align: center;
}

.add-button:hover {
  background-color: #d0d0d0;
}

.move-dropdown {
  position: absolute;
  top: 100%;
  left: 0;
  z-index: 9999;
  background-color: #fff;
  border: 1px solid #ccc;
  border-radius: 4px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  width: 200px; /* Adjust as needed */
  padding: 4px 0;
  display: none;
  font-family: sans-serif;
}

.move-dropdown ul {
  list-style: none;
  margin: 0;
  padding: 0;
}

.move-dropdown li {
  text-align: left;
  padding: 8px 12px;
  cursor: pointer;
  transition: background-color 0.2s ease;
}

.move-dropdown li:hover {
  background-color: #f0f0f0;
}

.dropdown-wrapper {
  position: relative; /* This anchors the dropdown */
  display: inline-block; /* Optional, keeps it tight */
}

.card-checkbox {
  position: absolute;
  top: 8px;
  left: 8px;
  z-index: 10;
}


.card-meta {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
  min-height: 20px;           /* Ensures vertical space is reserved */
  visibility: visible;     
}
.card-item.status-unexecuted {
  background-color: #fff1f0; /* soft red */
  border-color: #ffa39e
}

.card-item.status-manual {
  background-color: #fffbe6; /* soft yellow */
  border-color: #ffe58f;
}

.card-item.status-auto {
  background-color: #f6ffed; /* soft green */
  border-color: #b7eb8f;
}
.card-item.status-listed {
  background-color: #e6f7ff; /* soft blue */
  border-color: #91d5ff;
}
.image-button {
  background: none;
  border: none;
  padding: 0;
  cursor: pointer;
}

</style>
<script>
  window.submitCardForm = function(collectionId, cardId, targetUrl) {
    const visibleCards = document.getElementById(`visible-cards-${collectionId}`);
    let cardIds = [];

    if (visibleCards && visibleCards.value) {
      try {
        cardIds = JSON.parse(visibleCards.value).map(Number);
      } catch (e) {
        console.warn("Invalid JSON in visibleCards:", e);
      }
    }

    const form = document.getElementById(`view-card-form-${collectionId}`);
    form.action = targetUrl;
    visibleCards.value = JSON.stringify(cardIds);  // ensure value is set
    form.submit();
  };



  
function priceCollection(collectionId) {
    
    $.ajax({
  url: `/price_collection/${collectionId}/`,
  method: "GET",
  traditional: true,  // ‚úÖ prevents jQuery from adding [] to array keys
  success: function(response) {
    if (response.error) {
      alert("Error: " + response.message);
    } else {
      location.reload();
    }
  },
  error: function(xhr, status, error) {
    console.error("AJAX error:", error);
    alert("Request failed: " + error);
  }
});

}

</script>



{% load custom_tags %}
<div id="collection-{{ collection.id }}" class="collection">
<div class="collection-node" data-id="{{ collection.id }}">
  <div class="collection-header">
    
    <div class="collection-title-{{ collection.id }}">
    <h2 id="collection-title-{{ collection.id }}">
        {{ collection.id }}. {{ collection.name }} (<span id="card-count-{{ collection.id }}">{{ collection.cards.count }}</span>)
    </h2>

    <button onclick="addCard({{ collection.id }})">‚ûï</button>
    <button onclick="removeCollection({{ collection.id }})">üóëÔ∏è</button>
    <button onclick="saveTitle({{ collection.id }})">üíæ</button>
    <button onclick="submitCardForm({{ collection.id }}, null, '/crop_review/{{ collection.id }}/')">‚úÇ</button>
    <button onclick="submitCardForm({{ collection.id }}, null, '/image_search_collection/{{ collection.id }}/')">üîç</button>
    <button onclick="submitCardForm({{ collection.id }}, null, '/price_collection/{{ collection.id }}/')">üí≤</button>
    <button onclick="openForAutomaticInput({{ collection.id }})">üì¨</button>
    
    <div class="dropdown-wrapper">
      <button onclick="toggleMoveCollectionDropdown({{ collection.id }})" title="Move">üìÇ</button>
      <div id="move-collection-{{collection.id}}" class="move-dropdown" style="display: none;">
        <ul>
            {% for targetCollection in collections %}
            <li onclick="moveToCollection(null, '{{ collection.id }}', '{{ targetCollection.id }}')">
                {{targetCollection.id}}. {{targetCollection.name}}
            </li>
            {% endfor %}
        </ul>
      </div>
    </div>
    <input type="text"
      name="collection_name_{{ collection.id }}"
      value="{{ collection.name }}"
      style="width: 50%; box-sizing: border-box;"
      data-id="{{ collection.id }}"
      placeholder="Change collection name..."
      onchange="saveTitle({{ collection.id }})">
  </div>
  <div class="card-sort-controls">
  Sort: 
    <select onchange="sortCardsInModule(this)">
      <option value="year">Year</option>
      <option value="brand">Brand</option>
      <option value="name">Name</option>
      <option value="id">Default</option>
    </select>
  </div>
  <div class="card-filter-controls">
    <form id="view-card-form-{{ collection.id }}" method="POST" style="display: none;">
    <input type="hidden" name="card_ids" id="visible-cards-{{ collection.id }}">
  </form>

  Status: 
    <select onchange="filterCardsInModule(this, {{ collection.id }})">
      {% get_all_options "status" as options %}
      {% for option in options %}
        <option value="status">{{ option }}</option>
      {% endfor %}
    
  Year:
    <select onchange="filterCardsInModule(this, {{ collection.id }})">
      {% get_all_options "year" None collection.id as options %}
      {% for option in options %}
        <option value="year">{{ option }}</option>
      {% endfor %}
    
  Brand: 
    <select onchange="filterCardsInModule(this, {{ collection.id }})">
      {% get_all_options "brands" None collection.id as options %}
      {% for option in options %}
        <option value="brand">{{ option }}</option>
      {% endfor %}
      
</select>

  </div>

  <div style="text-align: center; margin-top: 20px;">
    <button onclick="toggleAttributePanel()">‚öôÔ∏è Select Attributes</button>
  </div>

    <div id="attributePanel" style="display: none; margin: 10px auto; text-align: center;">
      <label><input type="checkbox" class="attr-toggle" value="name" checked> Name</label>
      <label><input type="checkbox" class="attr-toggle" value="thumb" checked> Thumbnail</label>
      <label><input type="checkbox" class="attr-toggle" value="set"> Set</label>
      <label><input type="checkbox" class="attr-toggle" value="nr" >Card #</label>
      <label><input type="checkbox" class="attr-toggle" value="team" >Team</label>
      <label><input type="checkbox" class="attr-toggle" value="serial" >Serial</label><br>
      <label><input type="checkbox" class="attr-toggle" value="list_price" >List Price</label>
      <label><input type="checkbox" class="attr-toggle" value="highlow" >Ebay Low / High</label>
      <label><input type="checkbox" class="attr-toggle" value="mmm" >Ebay Mean / Meadian / Mode</label>
      <label><input type="checkbox" class="attr-toggle" value="ids" >IDs</label>
      <label><input type="checkbox" class="attr-toggle" value="highlowsold" >Sold Low / High</label>
      <label><input type="checkbox" class="attr-toggle" value="soldavgs" >Last Sale / Last 5 Avg</label>
      <label><input type="checkbox" class="attr-toggle" value="avgonly" checked>Avg Sale</label>
    </div>
    <div class="card-list">
    {% for card in collection.cards.all %}
      {% with display_name=card.active_search_results|get_attribute:"display_full_name" display_year=card.active_search_results|get_attribute:"display_year" display_brand=card.active_search_results|get_attribute:"display_brand" display_subset=card.active_search_results|get_attribute:"display_subset" display_team=card.active_search_results|get_attribute:"display_team" display_city=card.active_search_results|get_attribute:"display_city" display_serial=card.active_search_results|get_attribute:"display_serial" %}
      {% with tooltip_string=display_name|stringformat:"s"|add:" "|add:display_year|stringformat:"s"|add:" "|add:display_brand|stringformat:"s"|add:" "|add:display_subset|stringformat:"s" %}
      {% with refinement_status=card.active_search_results.refinement_status|status_icon_meta pricing_status=card.active_search_results.pricing_status|status_icon_meta id_status=card.active_search_results.id_status|status_icon_meta%}
      
      <div id="card-{{ card.id }}" class="card">    
      <div class="card-item status-{{ card.active_search_results.overall_status|lower }}">
        <div class="card-checkbox">
            <input type="checkbox" onchange="updateSelection({{collection.id}})" name="selected_cards" value="{{ card.id }}" id="select-card-{{ card.id }}"><br><br>
        </div>
  

        <div class="card-meta">
          
        </div>

        <div class="card-meta" data-attr="name">
          {{ display_name }}
        </div>

        <div class="card-meta" data-attr="set">
          {{ display_year }} {{ display_brand }} {{ display_subset }}
        </div>

        <div class="card-meta" data-attr="nr">
          {{ card.active_search_results.card_number }}
        </div>

        <div class="card-meta" data-attr="team">
          {{ display_city }} {{ display_team }}
        </div>

        <div class="card-meta" data-attr="serial">
          {{ display_serial }}
        </div>

        <div class="card-meta" data-attr="list_price">
          ${{ card.active_search_results.list_price|floatformat:2 }}
        </div>

        <div class="card-meta" data-attr="highlow">
          ${{ card.active_search_results.ebay_low_price|floatformat:2 }} / ${{ card.active_search_results.ebay_high_price|floatformat:2 }}
        </div>

        <div class="card-meta" data-attr="mmm">
          ${{ card.active_search_results.ebay_mean_price|floatformat:2 }} / ${{ card.active_search_results.ebay_meadian_price|floatformat:2 }} / ${{ card.active_search_results.ebay_mode_price|floatformat:2 }}
        </div>

        <div class="card-meta" data-attr="highlowsold">
          ${{ card.active_search_results.ebay_low_sold_price|floatformat:2 }} /  ${{ card.active_search_results.ebay_high_sold_price|floatformat:2 }}
        </div>

        <div class="card-meta" data-attr="soldavgs">
            ${{ card.active_search_results.ebay_last_sold_price|floatformat:2 }} / ${{ card.active_search_results.ebay_last_five_avg_sold_price|floatformat:2 }}
        </div>
        <div class="card-meta" data-attr="avgonly">            
            ${{ card.active_search_results.ebay_avg_sold_price|floatformat:2 }}
        </div>

        <div class="card-meta" data-attr="ids">
          {{ card.id }}:{{ card.active_search_results.id }}
        </div>

          
        <div class="image-wrapper" data-attr="thumb">
          <button type="button" onclick='submitCardForm({{ collection.id }}, {{ card.id }}, "/card/{{card.id}}/")' class="image-button">
            <img src="{{ card.cropped_image.url }}" alt="{{ card.id }}" onerror="this.onerror=null; this.src='/static/images/missing_card.png';" class="thumbnail default">
            <img src="{{ card.cropped_reverse.url }}" alt="{{ card.id }} hover" onerror="this.onerror=null; this.src='/static/images/missing_reverse.png';" class="thumbnail hover">
          </button>
        </div>

        <div class="card-actions">
                
          <div class="tooltip-wrapper" data-tooltip="{{ tooltip_string }}">
              <button onclick="cropCard({{ collection.id }}, {{ card.id }})">‚úÇ</button>
          </div>
          
          <button onclick="toggleMoveDropdown({{card.id}})" title="Move">üìÇ</button>
          <button onclick="removeCard({{ card.id }})" title="Delete">üóëÔ∏è</button>

          <div id="move-card-{{card.id}}" class="move-dropdown" style="display: none;">
              <ul>
                  {% for targetCollection in collections %}
                  <li onclick="moveToCollection({{ card.id }}, '{{ collection.id }}', {{ targetCollection.id }})">
                      {{targetCollection.id}}. {{targetCollection.name}}
                  </li>
                  {% endfor %}
              </ul>
          </div>
        </div>
        <div>  
          <span title="ID Status: {{ card.active_search_results.id_status.title }}">{{ id_status.icon }}</span>
          <span title="Refinement Status: {{ card.active_search_results.refinement_status.title }}">{{ refinement_status.icon }}</span>
          <span title="Pricing Status: {{ card.active_search_results.pricing_status.title }}">{{ pricing_status.icon }}</span>
        </div>

        {% endwith %}
        {% endwith %}
        {% endwith %}
        
    </div>
    </div>
    {% endfor %}
    {% for subcollection in collection.subcollections.all %}
    
  <div class="card-item" 
    data-year="{{ display_year }}"
    data-brand="{{ display_brand }}"
    data-subset="{{ display_subset }}"
    data-search_count="{{ card.search_count }}">
    <div class="card-meta">
        {{subcollection.id}}<br>
    </div>
    <div class="card-meta">
         {{subcollection.name}}
    </div>
    
        <div class="image-wrapper">
            <img src="/static/images/missing_collection.png" alt="{{ subcollection.id }}" class="thumbnail default">
            <img src="/static/images/missing_collection_reverse.png" alt="{{ subcollection.id }} hover" class="thumbnail hover">
        </div>
        <div class="card-actions">
            <div class="tooltip-wrapper" data-tooltip="{{ subcollection.id }}">
                <button onclick="editCard({{ subcollection.id }})">‚úèÔ∏è</button>
            </div>
            <button onclick="toggleMoveDropdown(this)" title="Move">üìÇ</button>
            <button onclick="removeCard({{ subcollection.id }})" title="Delete">üóëÔ∏è</button>
        </div>
        
    </div>
    {% endfor %}
    
    <div class="card-item add-controls">
        <button class="add-button" onclick="triggerFileUpload({{ collection.id }})" title="Add Card">‚ûï Card</button>
        <button class="add-button" onclick="addSubcollection({{ collection.id }})" title="Add Subcollection">üìÅ Subcollection</button>
        <input type="file" id="fileInput_{{ collection.id }}" style="display: none;" accept="image/*" onchange="uploadImage({{ collection.id }}, this.files)" multiple>

    </div>

    </div>
</div>
</div>

<script>
function updateAttributeVisibility() {
  const selected = Array.from(document.querySelectorAll('.attr-toggle:checked'))
    .map(cb => cb.value);

  document.querySelectorAll('[data-attr]').forEach(el => {
    const attr = el.getAttribute('data-attr');
    el.style.display = selected.includes(attr) ? '' : 'none';
  });
}

// Initial render
updateAttributeVisibility();

// Re-run on checkbox change
document.querySelectorAll('.attr-toggle').forEach(cb => {
  cb.addEventListener('change', updateAttributeVisibility);
});

function toggleAttributePanel() {
  const panel = document.getElementById("attributePanel");
  panel.style.display = panel.style.display === "none" ? "block" : "none";
}

function getSelectedAttributes() {
  const checkboxes = document.querySelectorAll(".attr-toggle");
  return Array.from(checkboxes)
    .filter(cb => cb.checked)
    .map(cb => cb.value);
}

function sortCardsInModule(selectEl) {
  // Traverse up to the nearest .collection container
  const container = selectEl.closest('.collection');
  if (!container) {
    console.warn('No collection container found for sorting');
    return;
  }
  
  const collectionId = container.id.split('-')[1];
  const cardList = container.querySelector('.card-list');
  if (!cardList) {
    console.warn('No card list found in collection');
    return;
  }

  const cards = Array.from(cardList.querySelectorAll('.card'));

  // Exclude the last item (e.g. add-controls)
  const lastItem = cardList.lastElementChild;
  const sortableCards = cards.filter(card => card !== lastItem);

  const key = selectEl.value;
  sortableCards.sort((a, b) => {
    const aData = a.querySelector('.card-item')?.dataset || {};
    const bData = b.querySelector('.card-item')?.dataset || {};

    const aVal = aData[key] || '';
    const bVal = bData[key] || '';

    if (key === 'search_count') {
      return parseInt(bVal) - parseInt(aVal);
    }
    return aVal.localeCompare(bVal);
  });

  // Reflow sorted cards
  sortableCards.forEach(card => cardList.appendChild(card));
  if (lastItem) cardList.appendChild(lastItem); // Preserve final control
}


function filterCardsInModule(selectEl, collectionId) {
  const container = document.getElementById(`collection-${collectionId}`);
  if (!container) {
    console.warn('No collection container found for filtering');
    return;
  }

  const cardList = container.querySelector('.card-list');
  if (!cardList) {
    console.warn('No card list found in collection');
    return;
  }

  const cards = Array.from(cardList.querySelectorAll('.card'));
  console.log(cards)
  const lastItem = cardList.lastElementChild;
  const selectedOption = selectEl.selectedOptions?.[0];
  console.log("Selected option:", selectedOption);
  const key = selectedOption?.value ?? '';
  console.log("collectionId:", collectionId);
  const filterValue = selectedOption?.text ?? '';

  console.log("Filtering by:", key, filterValue, collectionId);

  const visibleCardIds = [];

  cards.forEach(card => {
    if (card === lastItem) {
      card.style.display = ''; // Always show control element
      return;
    }

    const data = card.querySelector('.card-item')?.dataset || {};
    const val = data[key] || '';

    const isMatch = filterValue === ''
      || (key === 'search_count'
          ? parseInt(val) === parseInt(filterValue)
          : val === filterValue);

    card.style.display = isMatch ? '' : 'none';

    if (isMatch && data.id) {
      visibleCardIds.push(data.id);
    }
  });

  // Update hidden input with visible card IDs
  updateSelection(collectionId)
}

function updateSelection(collectionId) {
  const checkboxes = document.querySelectorAll('input[name="selected_cards"]:checked');
  const hiddenInput = document.getElementById(`visible-cards-`+collectionId);
  const selectedIds = Array.from(checkboxes).map(cb => cb.value);
  if (hiddenInput) {
    hiddenInput.value = JSON.stringify(selectedIds);
    console.log("Updated visible_cards input:", selectedIds);
  }
}

function triggerFileUpload(collectionId) {
  document.getElementById("fileInput_" + collectionId).click();
}

function uploadImage(collectionId, files) {
  if (!files || files.length === 0) return;

  const formData = new FormData();
  for (let i = 0; i < files.length; i++) {
    formData.append("images", files[i]); // Django expects 'images' as a list
  }
  formData.append("collection_id", collectionId);

  fetch("/upload_image/", {
    method: "POST",
    body: formData,
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      location.reload(); // or dynamically insert new cards
    } else {
      alert("Upload failed: " + data.message);
    }
  });
}


function getCSRFToken() {
  return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

function toggleChildren(el) {
  const node = el.closest('.collection-node');
  const subs = node.querySelector('.subcollections');
  subs.style.display = subs.style.display === 'none' ? 'block' : 'none';
  el.textContent = subs.style.display === 'none' ? '‚ñ∂' : '‚ñº';
}

function addCard(collectionId) {
  // AJAX call to Django view to create a new card
  console.log("Add card to collection:", collectionId)
  window.location.href = "/upload_image/" + collectionId;
}

function openForAutomaticInput(collectionId) {
  fetch(`/set_default_collection/${collectionId}`);
}

function addSubcollection(parentId) {
  // AJAX call to create nested collection
  $.post("/collection_create/", {
        collection_id: parentId
    }, function(response) {
        if (response.error) {
            alert("Error: " + response.message);
        } else {
            location.reload()
        }
    });
}

function removeCard(cardId) {
  // AJAX call to delete card
  $.post("/delete/", {
        card_id: cardId,
    }, function(response) {
        if (response.error) {
            alert("Error: " + response.message);
        } else {
            location.reload()
        }
    });
}

function toggleMoveDropdown(cardId) {
  const dropdown = document.getElementById('move-card-' + cardId);
  dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
}

function toggleMoveCollectionDropdown(collectionId) {
  const dropdown = document.getElementById('move-collection-' + collectionId);
  dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
}

function refreshCollectionCount(collectionId) {
  const container = document.querySelector(`#collection-${collectionId}`);
  const cardList = container?.querySelector('.card-list');
  if (!cardList) return;

  const count = Array.from(cardList.children).filter(child =>
    child.classList.contains('card')
  ).length;

  const countSpan = document.querySelector(`#card-count-${collectionId}`);
  if (countSpan) {
    countSpan.textContent = count;
  }
}

function moveToCollection(cardId, collectionToMoveId, targetCollectionId) {
  let selectedCardIds;
  const visibleCards = document.getElementById(`visible-cards-${collectionToMoveId}`).value;
  if (visibleCards)
    selectedCardIds = JSON.parse(visibleCards).map(Number);
  else
    selectedCardIds = ""
  const initiatingCardId = cardId

  //if I have an initiating cardid and no visibleCards, move the single card to the targetcollection
  //if initiatingCardId is none, this will fall through to collection-collection 
  if ((selectedCardIds == "") || (selectedCardIds == "[]"))
    selectedCardIds = [initiatingCardId]

  fetch('/move_to_collection/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      //'X-CSRFToken': getCookie('csrftoken')  // Make sure you have a getCookie() helper
    },
    body: JSON.stringify({
      collection_to_move: collectionToMoveId,      
      cards_to_move:selectedCardIds,
      target_collection: targetCollectionId,
    })
  })
  .then(response => {
    console.log("Successfully");
    location.reload()
  })
  .catch(err => {
    console.error("‚ùå Error sending data:", err);
  });
}

//single card move clicked (could be selections)
function moveCardToCollection(cardId, collectionId) {
  fetch(`/move_to_collection/${cardId}/${collectionId}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ collection_id: collectionId })
  })
  .then(response => {
    if (!response.ok) throw new Error('Move failed');
    return response.json();
  })
  .then(data => {
    const cardElement = document.querySelector(`#card-${cardId}`);
    const oldContainer = cardElement?.closest('.collection');
    const newContainer = document.querySelector(`#collection-${collectionId}`);

    if (cardElement && newContainer) {
      const oldId = oldContainer?.dataset?.id;

      // üîí Close the dropdown before moving
      const dropdown = cardElement.querySelector('.move-dropdown');
      if (dropdown) dropdown.style.display = 'none';

      // üßπ Remove the card before updating counts
      cardElement.remove();

      // üì¶ Insert into new container (second-to-last)
      const cardList = newContainer.querySelector('.card-list');
      const children = cardList?.children || [];
      const insertBeforeTarget = children.length > 1 ? children[children.length - 1] : null;
      cardList?.insertBefore(cardElement, insertBeforeTarget);

      // üîÑ Refresh counts
      if (oldId) refreshCollectionCount(oldId);
      refreshCollectionCount(collectionId);
    }
  })
  .catch(error => {
    console.error('Error moving card:', error);
  });
}

function removeCollection(collectionId) {
  // AJAX call to delete card
  $.post("/delete/", {
        collection_id: collectionId,
    }, function(response) {
        if (response.error) {
            alert("Error: " + response.message);
        } else {
            location.reload()
        }
    });
}

function searchCollection(collectionId) {
  const container = document.getElementById(`collection-${collectionId}`);
  if (!container) {
    console.warn("No collection found with ID:", collectionId);
    return;
  }

  console.log(visibleCards);
  const encodedIds = encodeURIComponent(visibleCards.join(','));
  const url = `/crop_review/${collectionId}?card_ids=${encodedIds}`;

  fetch(`/image_search_collection/${collectionId}/`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ cards: visibleCards })
});



}

function saveTitle(collectionId) {
  const $input = $("input[name='collection_name_" + collectionId + "']");
  const newName = $input.val();

  console.log("Save title:", collectionId);

  $.post("/update_collection/", {
    collectionId: collectionId,
    name: newName
  }, function(response) {
    if (response.error) {
      alert("Error: " + response.message);
    } else {
      // Update visible title (assuming there's an element with class .collection-title)
      $(".collection-title[data-id='" + collectionId + "'] h2").text(collectionId + ". " + newName);

      // Clear the input field
      $input.val("");
    }
  });
}

function cropCard(collectionId, cardId) {
    window.location.href = "/crop_review/"+collectionId
    const cardIds = JSON.parse(cardId).map(Number);
}

function cropCollection(collectionId) {
  const visibleCards = document.getElementById(`visible-cards-${collectionId}`);
  const cardIds = JSON.parse(visibleCards.value).map(Number);
  window.location.href = "/crop_review/"+collectionId
}

</script>
