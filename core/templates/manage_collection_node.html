{% load custom_tags %}
{% load static %}
<script src="{% static 'js/collection_node.js' %}"></script>
<style>
  
.card-list {
  display: flex;
  flex-wrap: wrap; /* allows wrapping to next line if needed */
  gap: 12px;        /* spacing between cards */
  padding: 8px 0;
}

.card-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 150px;
  padding: 6px;
  border: 1px solid #ccc;
  border-radius: 6px;
  background-color: #f9f9f9;
  text-align: center;
  position: relative;
}

.card-count {
  position: absolute;
  top: 8px;
  left: 8px;
  z-index: 10;
  margin-bottom: 4px;
}

.status-icon {
  position: absolute;
  bottom: 2px;
  left: 2px;
  font-size: 0.85em;
}
.image-wrapper {
  position: relative;
  width: 150px;
  height: 210px; /* or match your image height */
  overflow: hidden;
  margin-bottom: 6px;
}

.thumbnail {
  position: absolute;
  top: 4px;
  left: 4px;
  width: calc(100% - 8px); /* ‚¨ÖÔ∏è account for padding */
  height: auto;
  border-radius: 4px;
  transition: opacity 0.3s ease;
}


.thumbnail.hover {
  opacity: 0;
  z-index: 2;
}

.image-wrapper:hover .thumbnail.hover {
  opacity: 1;
}

.image-wrapper:hover .thumbnail.default {
  opacity: 0;
}

.tooltip-wrapper {
  position: relative;
  display: inline-block;
}

.tooltip-wrapper::after {
  content: attr(data-tooltip);
  position: absolute;
  bottom: 125%; /* above the button */
  left: 50%;
  transform: translateX(-50%);
  background-color: #333;
  color: #fff;
  padding: 4px 8px;
  border-radius: 4px;
  white-space: nowrap;
  font-size: 0.75em;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s ease;
  z-index: 10;
}

.tooltip-wrapper:hover::after {
  opacity: 1;
}
.add-controls {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 6px;
  width: 144px;
  height: 274px;
  padding: 8px;
  border: 2px dashed #aaa;
  border-radius: 6px;
  background-color: #f0f0f0;
}

.card-sort-controls {
    margin-top: 6px;
}

.add-button {
  width: 100%;
  padding: 6px 0;
  font-size: 0.9em;
  background-color: #e0e0e0;
  border: 1px solid #ccc;
  border-radius: 4px;
  cursor: pointer;
  text-align: center;
}

.add-button:hover {
  background-color: #d0d0d0;
}

.move-dropdown {
  position: absolute;
  top: 100%;
  left: 0;
  z-index: 9999;
  background-color: #fff;
  border: 1px solid #ccc;
  border-radius: 4px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  width: 200px; /* Adjust as needed */
  padding: 4px 0;
  display: none;
  font-family: sans-serif;
}

.move-dropdown ul {
  list-style: none;
  margin: 0;
  padding: 0;
}

.move-dropdown li {
  text-align: left;
  padding: 8px 12px;
  cursor: pointer;
  transition: background-color 0.2s ease;
}

.move-dropdown li:hover {
  background-color: #f0f0f0;
}

.dropdown-wrapper {
  position: relative; /* This anchors the dropdown */
  display: inline-block; /* Optional, keeps it tight */
}

.card-checkbox {
  position: absolute;
  top: 8px;
  left: 8px;
  z-index: 10;
}


.card-meta {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
  min-height: 20px;           /* Ensures vertical space is reserved */
  visibility: visible;     
}
.card-item.status-unexecuted {
  background-color: #fff1f0; /* soft red */
  border-color: #ffa39e
}

.card-item.status-manual {
  background-color: #fffbe6; /* soft yellow */
  border-color: #ffe58f;
}

.card-item.status-auto {
  background-color: #f6ffed; /* soft green */
  border-color: #b7eb8f;
}
.card-item.status-listed {
  background-color: #e6f7ff; /* soft blue */
  border-color: #91d5ff;
}
.image-button {
  background: none;
  border: none;
  padding: 0;
  cursor: pointer;
}
.collection-status-group {
    display: flex;
    gap: 1rem;
    margin-top: 0.5rem;
}

.status-option {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

</style>
<div id="collection-{{ collection.id }}" class="collection">
<div class="collection-node" data-id="{{ collection.id }}">
  <div class="collection-header">
    
    <div class="collection-title-{{ collection.id }}">
    <h2 id="collection-title-{{ collection.id }}">
        {{ collection.id }}. {{ collection.name }} (<span id="card-count-{{ collection.id }}">{{ collection.cards.count }}</span>) {{ collection.status.field }}

    </h2>
    <div class="collection-status-group" id="status-group-{{ collection.id }}">
      {% get_choices as status_choices %}
    {% for value, label in status_choices %}
      <label class="status-option">
        <input 
            type="radio"
            name="status-{{ collection.id }}"
            value="{{ value }}"
            {% if collection.status == value %}checked{% endif %}
            onchange="saveCollectionField({{ collection.id }}, 'status', this.value)"
        >
        {{ label }}
      </label>

    {% endfor %}
    </div>
    <button onclick="removeCollection({{ collection.id }})">üóëÔ∏è</button>
    <button onclick="submitCardForm({{ collection.id }}, null, '/crop_review/{{ collection.id }}/')">‚úÇ</button>
    <button onclick="submitCardForm({{ collection.id }}, null, '/image_search_collection/{{ collection.id }}/')">üîç</button>
    <button onclick="submitCardForm({{ collection.id }}, null, '/price_collection/{{ collection.id }}/')">üí≤</button>
    <input type="text"
      name="collection_name_{{ collection.id }}"
      value="{{ collection.name }}"
      style="width: 50%; box-sizing: border-box;"
      data-id="{{ collection.id }}"
      placeholder="Change collection name..."
      onchange="saveCollectionField({{ collection.id }}, 'name', this.value)">
  </div>
  
  <div style="text-align: center; margin-top: 20px;">
    <button onclick="toggleAttributePanel()">‚öôÔ∏è Select Attributes</button>
  </div>

    <div id="attributePanel" style="display: none; margin: 10px auto; text-align: center;">
      <label><input type="checkbox" class="attr-toggle" value="name" checked> Name</label>
      <label><input type="checkbox" class="attr-toggle" value="thumb" checked> Thumbnail</label>
      <label><input type="checkbox" class="attr-toggle" value="set"> Set</label>
      <label><input type="checkbox" class="attr-toggle" value="nr" >Card #</label>
      <label><input type="checkbox" class="attr-toggle" value="team" >Team</label>
      <label><input type="checkbox" class="attr-toggle" value="serial" >Serial</label><br>
      <label><input type="checkbox" class="attr-toggle" value="list_price" >List Price</label>
      <label><input type="checkbox" class="attr-toggle" value="highlow" >Ebay Low / High</label>
      <label><input type="checkbox" class="attr-toggle" value="mmm" >Ebay Mean / Meadian / Mode</label>
      <label><input type="checkbox" class="attr-toggle" value="ids" >IDs</label>
      <label><input type="checkbox" class="attr-toggle" value="highlowsold" >Sold Low / High</label>
      <label><input type="checkbox" class="attr-toggle" value="soldavgs" >Last Sale / Last 5 Avg</label>
      <label><input type="checkbox" class="attr-toggle" value="avgonly">Avg Sale</label>
      <label><input type="checkbox" class="attr-toggle" value="msrp" checked>MSRP</label>
    </div>
    <div class="card-list">
    {% for card in collection.cards.all %}
      {% with display_name=card.active_search_results|get_attribute:"display_full_name" display_year=card.active_search_results|get_attribute:"display_year" display_brand=card.active_search_results|get_attribute:"display_brand" display_subset=card.active_search_results|get_attribute:"display_subset" display_team=card.active_search_results|get_attribute:"display_team" display_city=card.active_search_results|get_attribute:"display_city" display_serial=card.active_search_results|get_attribute:"display_serial" %}
      {% with tooltip_string=display_name|stringformat:"s"|add:" "|add:display_year|stringformat:"s"|add:" "|add:display_brand|stringformat:"s"|add:" "|add:display_subset|stringformat:"s" %}
      {% with refinement_status=card.active_search_results.refinement_status|status_icon_meta pricing_status=card.active_search_results.pricing_status|status_icon_meta id_status=card.active_search_results.id_status|status_icon_meta%}
      
      <div id="card-{{ card.id }}" class="card">    
      <div class="card-item status-{{ card.active_search_results.overall_status|lower }}">
        <div class="card-checkbox">
            <input type="checkbox" onchange="updateSelection({{collection.id}})" name="selected_cards" value="{{ card.id }}" id="select-card-{{ card.id }}"><br><br>
        </div>
  
        <div class="card-meta" data-attr="name">
          {{ display_name }}
        </div>

        <div class="card-meta" data-attr="set">
          {{ display_year }} {{ display_brand }} {{ display_subset }}
        </div>

        <div class="card-meta" data-attr="list_price">
          ${{ card.active_search_results.list_price|floatformat:2 }}
        </div>

        <div class="card-meta" data-attr="msrp">
          ${{ card.active_search_results.ebay_msrp|floatformat:2 }}
        </div>

        <div class="card-meta" data-attr="ids">
          {{ card.id }}:{{ card.active_search_results.id }}
        </div>
          
        <div class="image-wrapper" data-attr="thumb">
          <button type="button" onclick='submitCardForm({{ collection.id }}, {{ card.id }}, "/card/{{card.id}}/")' class="image-button">
            <img src="{{ card.cropped_image.url }}" loading="lazy" alt="{{ card.id }}" onerror="this.onerror=null; this.src='/static/images/missing_card.png';" class="thumbnail default">
            <img src="{{ card.cropped_reverse.url }}" loading="lazy" alt="{{ card.id }} hover" onerror="this.onerror=null; this.src='/static/images/missing_reverse.png';" class="thumbnail hover">
          </button>
        </div>

        <div class="card-actions">
                
          <div class="tooltip-wrapper" data-tooltip="{{ tooltip_string }}">
              <button onclick="cropCard({{ collection.id }}, {{ card.id }})">‚úÇ</button>
          </div>
          
          <button onclick="toggleMoveDropdown({{card.id}})" title="Move">üìÇ</button>
          <button onclick="removeCard({{ card.id }})" title="Delete">üóëÔ∏è</button>

          <div id="move-card-{{card.id}}" class="move-dropdown" style="display: none;">
              <ul>
                  {% for targetCollection in collections %}
                  <li onclick="moveToCollection({{ card.id }}, '{{ collection.id }}', {{ targetCollection.id }})">
                      {{targetCollection.id}}. {{targetCollection.name}}
                  </li>
                  {% endfor %}
              </ul>
          </div>
        </div>
        <div>  
          <span title="ID Status: {{ card.active_search_results.id_status.title }}">{{ id_status.icon }}</span>
          <span title="Refinement Status: {{ card.active_search_results.refinement_status.title }}">{{ refinement_status.icon }}</span>
          <span title="Pricing Status: {{ card.active_search_results.pricing_status.title }}">{{ pricing_status.icon }}</span>
        </div>

        {% endwith %}
        {% endwith %}
        {% endwith %}
        
    </div>
    </div>
    {% endfor %}
    {% for subcollection in collection.subcollections.all %}
    
  <div class="card-item" 
    data-year="{{ display_year }}"
    data-brand="{{ display_brand }}"
    data-subset="{{ display_subset }}"
    data-search_count="{{ card.search_count }}">
    <div class="card-meta">
        {{subcollection.id}}<br>
    </div>
    <div class="card-meta">
         {{subcollection.name}}
    </div>
    
        <div class="image-wrapper">
            <img src="/static/images/missing_collection.png" alt="{{ subcollection.id }}" class="thumbnail default">
            <img src="/static/images/missing_collection_reverse.png" alt="{{ subcollection.id }} hover" class="thumbnail hover">
        </div>
        <div class="card-actions">
            <div class="tooltip-wrapper" data-tooltip="{{ subcollection.id }}">
                <button onclick="editCard({{ subcollection.id }})">‚úèÔ∏è</button>
            </div>
            <button onclick="toggleMoveDropdown(this)" title="Move">üìÇ</button>
            <button onclick="removeCard({{ subcollection.id }})" title="Delete">üóëÔ∏è</button>
        </div>
        
    </div>
    {% endfor %}
    
    <div class="card-item add-controls">
        <button name="card" class="add-button" onclick='triggerFileUpload("cardFileInput_{{ collection.id }}")' title="Add Card">‚ûï Card</button>
        <button name="slab" class="add-button" onclick='triggerFileUpload("slabFileInput_{{ collection.id }}")' title="Add Slab">‚ûï Slab</button>
        <button class="add-button" onclick="addSubcollection({{ collection.id }})" title="Add Subcollection">üìÅ Subcollection</button>
        <input type="file" id="cardFileInput_{{ collection.id }}" style="display: none;" accept="image/*" onchange="uploadImage({{ collection.id }}, this.files)" multiple>
        <input type="file" id="slabFileInput_{{ collection.id }}" style="display: none;" accept="image/*" onchange="uploadSlab({{ collection.id }}, this.files)" multiple>

    </div>

    </div>
</div>
</div>
